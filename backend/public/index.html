<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="platform_title">Jamoatchilik Qurilish - Гражданский Контроль</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Стили остаются теми же, что и в предыдущем ответе */
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #ffffff; color: #1d1d1f; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1100px; }
        #map { height: 450px; border-radius: 1rem; background-color: #e5e5e7; }
        .tab-active { color: #007aff; border-bottom: 2px solid #007aff; font-weight: 600; padding-bottom: 8px; }
        .tab:not(.tab-active) { color: #515154; padding-bottom: 8px; }
        .tab:hover { color: #007aff; }
        .message-box { position: fixed; bottom: 25px; right: 25px; padding: 0.8rem 1.3rem; border-radius: 0.75rem; color: white; z-index: 1000; display: none; max-width: 380px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); opacity: 0; transform: translateY(15px); transition: opacity 0.35s ease-out, transform 0.35s ease-out; font-size: 0.9rem; font-weight: 500; }
        .message-box.show { display: block; opacity: 1; transform: translateY(0); }
        .message-box.success { background-color: #34c759; }
        .message-box.error { background-color: #ff3b30; }
        .message-box.info { background-color: #007aff; }
        .lang-dropdown { position: relative; display: inline-block; }
        .lang-dropdown-content { display: none; position: absolute; right: 0; background-color: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); min-width: 120px; box-shadow: 0px 10px 25px rgba(0,0,0,0.1); z-index: 10; border-radius: 0.75rem; border: 1px solid rgba(0, 0, 0, 0.08); overflow: hidden; }
        .lang-dropdown-content button { color: #1d1d1f; padding: 10px 15px; text-decoration: none; display: block; width: 100%; text-align: left; background: none; border: none; cursor: pointer; font-size: 0.9rem; transition: background-color 0.15s ease-in-out; }
        .lang-dropdown-content button:hover { background-color: rgba(0, 0, 0, 0.05); }
        .lang-dropdown:hover .lang-dropdown-content { display: block; }
        .lang-button { background-color: #f5f5f7; color: #1d1d1f; border: none; padding: 8px 12px; border-radius: 999px; transition: background-color 0.2s ease; cursor: pointer; }
        .lang-button:hover { background-color: #e5e5e7; }
        .content-section { transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out; }
        .content-section.hidden { opacity: 0; height: 0; overflow: hidden; padding: 0 !important; margin: 0 !important; border: none !important; transform: translateY(20px); pointer-events: none; }
        .content-section:not(.hidden) { transform: translateY(0); }
        .icon { display: inline-block; width: 1.1em; height: 1.1em; margin-right: 0.4em; vertical-align: -0.15em; }
        .icon-lg { width: 1.5em; height: 1.5em; margin-right: 0.5em; vertical-align: -0.25em; }
        .icon-xl { width: 2.5em; height: 2.5em; margin-bottom: 0.5rem; color: #007aff; }
        .landing-hero { padding: 6rem 1rem; background-color: #f5f5f7; text-align: center; }
        .landing-hero h1 { font-size: 2.8rem; font-weight: 700; line-height: 1.1; color: #1d1d1f; margin-bottom: 1rem; } @media (min-width: 768px) { .landing-hero h1 { font-size: 4rem; } }
        .landing-hero p { font-size: 1.1rem; color: #515154; max-width: 650px; margin: 0 auto 2rem auto; line-height: 1.5; } @media (min-width: 768px) { .landing-hero p { font-size: 1.3rem; } }
        .feature-card { background-color: #ffffff; border: 1px solid #e5e5e7; padding: 2rem; border-radius: 1rem; text-align: center; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); }
        .feature-card h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: #1d1d1f; }
        .feature-card p { font-size: 0.95rem; color: #515154; line-height: 1.6; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; border-radius: 999px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; border: none; text-decoration: none; }
        .btn:active { transform: scale(0.98); } .btn:disabled { background-color: #d1d1d6; cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: #007aff; color: white; } .btn-primary:hover:not(:disabled) { background-color: #0071e3; }
        .btn-secondary { background-color: #e5e5e7; color: #1d1d1f; } .btn-secondary:hover:not(:disabled) { background-color: #d1d1d6; }
        .landing-section { padding: 4rem 1rem; border-bottom: 1px solid #e5e5e7; } .landing-section:last-child { border-bottom: none; }
        .landing-section h2 { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 3rem; color: #1d1d1f; } @media (min-width: 768px) { .landing-section h2 { font-size: 2.8rem; margin-bottom: 4rem;} }
        .step-card { background-color: white; border: 1px solid #e5e5e7; padding: 1.5rem; border-radius: 1rem; text-align: center; }
        .step-number { display: inline-block; width: 40px; height: 40px; line-height: 40px; border-radius: 50%; background-color: #007aff; color: white; font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }
        .step-card h3 { font-weight: 600; margin-bottom: 0.5rem; } .step-card p { font-size: 0.9rem; color: #515154; }
        .img-placeholder { background-color: #e5e5e7; border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: #8a8a8e; font-size: 0.9rem; overflow: hidden; min-height: 150px; }
        .img-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .list-card { background-color: #ffffff; border: 1px solid #e5e5e7; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; transition: box-shadow 0.2s ease; }
        .list-card:hover { box-shadow: 0 5px 15px rgba(0, 0, 0, 0.07); }
        .list-card h3 { font-size: 1.1rem; font-weight: 600; color: #1d1d1f; margin-bottom: 0.5rem; }
        .list-card h4 { font-size: 1rem; font-weight: 600; color: #1d1d1f; margin-bottom: 0.25rem; }
        .list-card p, .list-card li { font-size: 0.9rem; color: #515154; line-height: 1.5; }
        .list-card .font-medium { color: #1d1d1f; font-weight: 500; }
        .report-card-meta { font-size: 0.8rem; color: #8a8a8e; margin-top: 0.75rem; border-top: 1px solid #f5f5f7; padding-top: 0.75rem; }
        .report-card-meta span { margin-right: 1rem; display: inline-flex; align-items: center; }
        .report-card-meta .icon { width: 0.9em; height: 0.9em; margin-right: 0.25em; vertical-align: -0.1em;}
        label { font-weight: 500; color: #1d1d1f; margin-bottom: 0.5rem; display: block;}
        input[type="text"], input[type="file"], select, textarea { background-color: #f5f5f7; border: 1px solid #d1d1d6; border-radius: 0.75rem; padding: 12px 15px; font-size: 0.95rem; color: #1d1d1f; width: 100%; transition: border-color 0.2s ease, box-shadow 0.2s ease; box-sizing: border-box; }
        input[type="text"]:focus, select:focus, textarea:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); }
        input[type="file"] { padding: 8px 10px; cursor: pointer; }
        input[type="file"]::file-selector-button { margin-right: 1rem; padding: 6px 12px; border-radius: 0.5rem; background-color: #e5e5e7; border: none; color: #1d1d1f; cursor: pointer; transition: background-color 0.2s; font-weight: 500; font-size: 0.85rem;}
        input[type="file"]::file-selector-button:hover { background-color: #d1d1d6;}
        input::placeholder, textarea::placeholder { color: #8a8a8e; }
        select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%23515154"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.2em 1.2em; padding-right: 2.5rem; }
        footer { background-color: #f5f5f7; color: #515154; padding: 2rem 1rem; font-size: 0.85rem; margin-top: 4rem; }
        .break-words { word-wrap: break-word; overflow-wrap: break-word; }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-gray-200/80">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
             <a href="#" onclick="showSection('landing-section', true); return false;" class="text-xl font-semibold text-gray-800 hover:text-blue-600 transition duration-150 ease-in-out" data-lang-key="platform_name">
                Jamoatchilik Qurilish
            </a>

             <div class="hidden md:flex space-x-6 items-center">
                <button onclick="showSection('landing-section', true)" class="tab text-sm" data-section="landing-section" data-lang-key="nav_home">Главная</button>
                <button onclick="showSection('map-section', true)" class="tab text-sm" data-section="map-section" data-lang-key="nav_map">Карта</button>
                <button onclick="showSection('projects-section', true)" class="tab text-sm" data-section="projects-section" data-lang-key="nav_projects">Проекты</button>
                <button onclick="showSection('contractors-section', true)" class="tab text-sm" data-section="contractors-section" data-lang-key="nav_contractors">Подрядчики</button>
                <button onclick="showSection('citizen-reports-public-section', true)" class="tab text-sm" data-section="citizen-reports-public-section" data-lang-key="nav_public_reports">Отчеты</button>
                <button onclick="showSection('report-section', true)" class="tab text-sm" data-section="report-section" data-lang-key="nav_report">Сообщить</button>
            </div>

             <div class="flex items-center">
                <div class="lang-dropdown">
                    <button class="lang-button inline-flex items-center justify-center text-sm font-medium">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1.5"><path d="M7.75 2.75a.75.75 0 00-1.5 0v1.258a32.987 32.987 0 00-3.599.278.75.75 0 10.198 1.487A31.545 31.545 0 018.7 5.546.75.75 0 009 6.75v1.476c0 .698-.373 1.33-.955 1.688a18.69 18.69 0 00-1.966.83.75.75 0 10.593 1.331 17.192 17.192 0 012.328-.853.75.75 0 00.701-.031 17.194 17.194 0 012.328.853.75.75 0 10.593-1.331 18.683 18.683 0 00-1.965-.83C11.373 9.555 11 8.917 11 8.226V6.75a.75.75 0 00-.3-.606A31.545 31.545 0 0114.802 5.77a.75.75 0 10.198-1.487 32.987 32.987 0 00-3.599-.278V2.75z" /><path fill-rule="evenodd" d="M13 10.5a2.75 2.75 0 10-5.5 0 2.75 2.75 0 005.5 0zM10 12a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm0 1.5a9.5 9.5 0 100-19 9.5 9.5 0 000 19z" /></svg>
                        <span id="current-lang">RU</span>
                    </button>
                    <div class="lang-dropdown-content">
                        <button onclick="setLanguage('ru')">Русский (RU)</button>
                        <button onclick="setLanguage('en')">English (EN)</button>
                        <button onclick="setLanguage('uz')">O'zbekcha (UZ)</button>
                    </div>
                </div>
                <button id="mobile-menu-button" class="ml-3 md:hidden p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
         <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button onclick="showSection('landing-section', true); closeMobileMenu();" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50" data-section="landing-section" data-lang-key="nav_home">Главная</button>
                <button onclick="showSection('map-section', true); closeMobileMenu();" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50" data-section="map-section" data-lang-key="nav_map">Карта</button>
                <button onclick="showSection('projects-section', true); closeMobileMenu();" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50" data-section="projects-section" data-lang-key="nav_projects">Проекты</button>
                <button onclick="showSection('contractors-section', true); closeMobileMenu();" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50" data-section="contractors-section" data-lang-key="nav_contractors">Подрядчики</button>
                <button onclick="showSection('citizen-reports-public-section', true); closeMobileMenu();" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50" data-section="citizen-reports-public-section" data-lang-key="nav_public_reports">Отчеты</button>
                <button onclick="showSection('report-section', true); closeMobileMenu();" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50" data-section="report-section" data-lang-key="nav_report">Сообщить</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 pt-4">

        <section id="landing-section" class="content-section">
            <div class="landing-hero rounded-xl mb-12 md:mb-16">
                <h1 data-lang-key="landing_title">Контролируйте строительство. Вместе.</h1>
                <p data-lang-key="landing_subtitle">Платформа "Jamoatchilik Qurilish" — ваш инструмент для прозрачного мониторинга государственных инфраструктурных проектов в Узбекистане. Узнавайте бюджеты, следите за сроками и влияйте на качество.</p>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="showSection('projects-section', true)" class="btn btn-primary w-full sm:w-auto" data-lang-key="landing_cta_projects">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon w-5 h-5"><path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0v-1.668A3.75 3.75 0 016.25 12h7.5a3.75 3.75 0 012.75 3.082V17.25a.75.75 0 001.5 0V2.75a.75.75 0 00-1.5 0v1.668A3.75 3.75 0 0113.75 8h-7.5a3.75 3.75 0 01-2.75-3.082V2.75z"></path></svg>
                        <span data-lang-key="landing_cta_projects">Изучить проекты</span>
                    </button>
                    <button onclick="showSection('report-section', true)" class="btn btn-secondary w-full sm:w-auto" data-lang-key="landing_cta_report">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon w-5 h-5"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd"></path></svg>
                        <span data-lang-key="landing_cta_report">Сообщить о проблеме</span>
                    </button>
                </div>
            </div>
             <div class="landing-section">
                <h2 data-lang-key="landing_how_it_works_title">Как это работает? Просто.</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="step-card"><span class="step-number">1</span><h3 data-lang-key="landing_how_step1_title">Находите проекты</h3><p data-lang-key="landing_how_step1_desc">Используйте интерактивную карту или список для поиска строящихся или завершенных объектов рядом с вами.</p></div>
                    <div class="step-card"><span class="step-number">2</span><h3 data-lang-key="landing_how_step2_title">Изучайте детали</h3><p data-lang-key="landing_how_step2_desc">Получите доступ к информации о бюджете, сроках, подрядчике и официальной документации по каждому проекту.</p></div>
                    <div class="step-card"><span class="step-number">3</span><h3 data-lang-key="landing_how_step3_title">Делитесь наблюдениями</h3><p data-lang-key="landing_how_step3_desc">Заметили проблему? Отправьте фото или комментарий с геолокацией прямо через платформу.</p></div>
                </div>
            </div>
            <div class="landing-section bg-gray-50 rounded-xl">
                <h2 data-lang-key="landing_features_title">Ключевые возможности</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card bg-white"><img src="/images/transparency-icon.png" class="icon-xl mx-auto" alt="Transparency Icon"><h3 data-lang-key="landing_feature1_title">Полная прозрачность</h3><p data-lang-key="landing_feature1_desc">Вся информация о бюджетах, сроках, подрядчиках и документации в одном месте.</p></div>
                    <div class="feature-card bg-white"><img src="/images/monitoring-icon.png" class="icon-xl mx-auto" alt="Monitoring Icon"><h3 data-lang-key="landing_feature2_title">Гражданский мониторинг</h3><p data-lang-key="landing_feature2_desc">Возможность для каждого гражданина сообщать о реальном состоянии объектов.</p></div>
                    <div class="feature-card bg-white"><img src="/images/ai-icon.png" class="icon-xl mx-auto" alt="AI Analysis Icon"><h3 data-lang-key="landing_feature3_title">AI-анализ отчетов</h3><p data-lang-key="landing_feature3_desc">Система анализирует данные от граждан и сравнивает их с официальными отчетами для выявления расхождений.</p></div>
                    <div class="feature-card bg-white"><img src="/images/rating-icon.png" class="icon-xl mx-auto" alt="Rating Icon"><h3 data-lang-key="landing_feature4_title">Рейтинг подрядчиков</h3><p data-lang-key="landing_feature4_desc">Публичный рейтинг компаний, основанный на качестве работ и отзывах граждан.</p></div>
                </div>
            </div>
            <div class="landing-section">
                <h2 data-lang-key="landing_benefits_title">Польза для всех</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <div>
                        <h3 class="text-xl font-semibold mb-4" data-lang-key="landing_benefits_citizens_title">Для Граждан</h3>
                        <ul class="space-y-3 text-gray-600">
                            <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg><span data-lang-key="landing_benefits_citizens1">Реальный контроль за расходованием бюджетных средств.</span></li>
                            <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg><span data-lang-key="landing_benefits_citizens2">Возможность влиять на качество инфраструктуры в своем городе.</span></li>
                            <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg><span data-lang-key="landing_benefits_citizens3">Удобный инструмент для обратной связи и сообщений о проблемах.</span></li>
                        </ul>
                    </div>
                    <div class="img-placeholder h-64 md:h-80"><img src="/images/citizen-feedback.jpg" alt="Гражданин использует платформу" loading="lazy"></div>
                    <div class="img-placeholder h-64 md:h-80 order-last md:order-first"><img src="/images/gov-analysis.jpg" alt="Анализ данных для государства" loading="lazy"></div>
                    <div class="order-first md:order-last">
                        <h3 class="text-xl font-semibold mb-4" data-lang-key="landing_benefits_gov_title">Для Государства</h3>
                        <ul class="space-y-3 text-gray-600">
                             <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg><span data-lang-key="landing_benefits_gov1">Повышение эффективности расходования бюджетных средств.</span></li>
                             <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg><span data-lang-key="landing_benefits_gov2">Своевременное выявление проблемных объектов и недобросовестных подрядчиков.</span></li>
                             <li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg><span data-lang-key="landing_benefits_gov3">Улучшение качества инфраструктуры и повышение доверия граждан.</span></li>
                        </ul>
                    </div>
                </div>
            </div>
             <div class="text-center py-12">
                <h2 class="text-2xl md:text-3xl font-bold mb-4" data-lang-key="landing_final_cta_title">Присоединяйтесь к контролю!</h2>
                <p class="text-gray-600 mb-8 max-w-xl mx-auto" data-lang-key="landing_final_cta_desc">Начните использовать платформу уже сегодня. Изучайте проекты в вашем районе или сообщите о проблеме, которую вы заметили.</p>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="showSection('map-section', true)" class="btn btn-primary w-full sm:w-auto" data-lang-key="landing_final_cta_map">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon w-5 h-5"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 103 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 002.274 1.765 11.842 11.842 0 00.757.433c.1.049.194.096.28.14l.018.008.006.003zM10 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" clip-rule="evenodd"></path></svg>
                        <span data-lang-key="landing_final_cta_map">Посмотреть карту</span>
                    </button>
                    <button onclick="showSection('report-section', true)" class="btn btn-secondary w-full sm:w-auto" data-lang-key="landing_final_cta_report">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon w-5 h-5"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A.75.75 0 0010 13.5h.253a.25.25 0 01.244.304l-.459 2.066A.75.75 0 0010 16.5h.75a.75.75 0 000-1.5h-.528a.25.25 0 01-.244-.304l.459-2.066A.75.75 0 0011 10.5h-.75a.75.75 0 000-1.5H9z" clip-rule="evenodd"></path></svg>
                        <span data-lang-key="landing_final_cta_report">Сообщить о проблеме</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="map-section" class="content-section bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 hidden">
            <h2 class="text-2xl md:text-3xl font-semibold mb-6 text-gray-800" data-lang-key="map_title">Интерактивная карта проектов</h2>
            <div id="map" class="border border-gray-200 z-0"></div> <p class="mt-4 text-sm text-gray-600" data-lang-key="map_hint">Нажмите на маркер для просмотра информации о проекте.</p>
        </section>

        <section id="projects-section" class="content-section bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 hidden">
             <h2 class="text-2xl md:text-3xl font-semibold mb-6 text-gray-800" data-lang-key="projects_title">Список Инфраструктурных Проектов</h2>
             <div class="mb-6 relative">
                 <input type="text" id="project-search" data-lang-placeholder-key="projects_search_placeholder" placeholder="Поиск по названию или подрядчику..." class="w-full p-3 pl-10 text-sm"> <div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400">
                     <svg class="w-5 h-5 " xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                 </div>
             </div>
             <div id="project-list" class="space-y-4">
                 <p class="text-gray-500 italic p-4" data-lang-key="projects_not_found">Загрузка проектов...</p> </div>
        </section>

        <section id="contractors-section" class="content-section bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 hidden">
             <h2 class="text-2xl md:text-3xl font-semibold mb-6 text-gray-800" data-lang-key="contractors_title">Рейтинг Подрядчиков</h2>
             <div id="contractor-list" class="space-y-4">
                  <p class="text-gray-500 italic p-4" data-lang-key="contractor_no_projects">Загрузка подрядчиков...</p> </div>
        </section>

        <section id="citizen-reports-public-section" class="content-section bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 hidden">
             <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                 <h2 id="public-reports-title" class="text-2xl md:text-3xl font-semibold text-gray-800" data-lang-key="public_reports_title">Публичные отчеты граждан</h2>
                 <button id="show-all-reports-button" class="btn btn-secondary hidden text-sm py-2 px-4" onclick="displayPublicReports(null)">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="icon w-4 h-4"><path fill-rule="evenodd" d="M4.5 2a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-11a.5.5 0 0 0-.5-.5h-7ZM5 13V3h6v10H5Z" clip-rule="evenodd" /><path d="M6.854 4.146a.5.5 0 0 1 0 .708L5.707 6l1.147 1.146a.5.5 0 0 1-.708.708L4.646 6.354a.5.5 0 0 1 0-.708L6.146 4.146a.5.5 0 0 1 .708 0Zm2.292 0a.5.5 0 0 0 0 .708L10.293 6l-1.147 1.146a.5.5 0 0 0 .708.708l1.5-1.5a.5.5 0 0 0 0-.708l-1.5-1.5a.5.5 0 0 0-.708 0Z"/></svg> <span data-lang-key="public_reports_show_all">Показать все отчеты</span>
                 </button>
             </div>
             <div id="public-reports-list" class="space-y-4">
                  <p class="text-gray-500 italic p-4" data-lang-key="report_no_reports">Загрузка отчетов...</p> </div>
        </section>

        <section id="report-section" class="content-section bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 hidden">
             <h2 class="text-2xl md:text-3xl font-semibold mb-2 text-gray-800" data-lang-key="report_title">Сообщить о состоянии объекта</h2>
             <p class="text-gray-600 mb-6 text-sm" data-lang-key="report_subtitle">Заметили проблему со строительством или состоянием объекта? Расскажите нам!</p>
             <form id="report-form" class="space-y-5" novalidate>
                 <div>
                     <label for="report-project" data-lang-key="report_select_project">Выберите проект:</label>
                     <select id="report-project" name="project" required>
                          <option value="" data-lang-key="report_select_placeholder" disabled selected>-- Выберите проект --</option>
                     </select>
                 </div>
                 <div>
                     <label for="report-comment" data-lang-key="report_comment_label">Ваш комментарий:</label>
                     <textarea id="report-comment" name="comment" rows="4" data-lang-placeholder-key="report_comment_placeholder" placeholder="Опишите проблему..." required></textarea>
                 </div>
                 <div>
                     <label for="report-photo" data-lang-key="report_attach_photo">Прикрепить фото:</label>
                     <input type="file" id="report-photo" name="report-photo" accept="image/jpeg, image/png, image/gif, image/webp">
                     <p class="text-xs text-gray-500 mt-1" data-lang-key="report_attach_hint">Допустимые форматы: JPG, PNG, GIF, WEBP (макс. 10MB).</p>
                 </div>
                  <div>
                     <label data-lang-key="report_geolocation_label">Геолокация:</label>
                     <p id="geolocation-status" class="text-sm text-gray-600" data-lang-key="report_geolocation_fetching">Получение координат...</p>
                     <input type="hidden" id="report-latitude" name="latitude">
                     <input type="hidden" id="report-longitude" name="longitude">
                 </div>
                 <button type="submit" class="btn btn-primary w-full py-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon w-5 h-5"><path d="M3.105 3.105a1.5 1.5 0 012.122 0l11.06 11.061a1.5 1.5 0 01-2.122 2.121L3.105 5.227a1.5 1.5 0 010-2.122z"></path><path d="M3.474 15.026a1.5 1.5 0 010-2.121L14.534 1.84a1.5 1.5 0 012.121 2.122L5.596 15.026a1.5 1.5 0 01-2.122 0z"></path></svg>
                     <span data-lang-key="report_submit_button">Отправить отчет</span>
                 </button>
             </form>

             <div id="citizen-reports" class="mt-10 border-t border-gray-200 pt-6">
                 <h3 class="text-xl font-semibold mb-4 text-gray-700" data-lang-key="report_latest_reports">Последние отчеты граждан:</h3>
                 <div id="reports-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                     <p class="text-gray-500 italic text-sm" data-lang-key="report_no_reports">Загрузка отчетов...</p> </div>
             </div>
        </section>

    </main>

    <footer>
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>&copy; <span id="footer-year">2025</span> <span data-lang-key="platform_name_footer">Jamoatchilik Qurilish</span>. <span data-lang-key="footer_rights">Все права защищены.</span></p>
        </div>
    </footer>

    <div id="message-box" class="message-box"></div>

    <script>
 const languages = {
            ru: {
                platform_title: "Jamoatchilik Qurilish - Гражданский Контроль",
                platform_name: "Jamoatchilik Qurilish",
                platform_name_footer: "Jamoatchilik Qurilish",
                nav_home: "Главная",
                nav_map: "Карта",
                nav_projects: "Проекты",
                nav_contractors: "Подрядчики",
                nav_public_reports: "Отчеты",
                nav_report: "Сообщить",
                landing_title: "Контролируйте строительство. Вместе.",
                landing_subtitle: "Платформа \"Jamoatchilik Qurilish\" — ваш инструмент для прозрачного мониторинга государственных инфраструктурных проектов в Узбекистане. Узнавайте бюджеты, следите за сроками и влияйте на качество.",
                landing_cta_projects: "Изучить проекты",
                landing_cta_report: "Сообщить о проблеме",
                landing_how_it_works_title: "Как это работает? Просто.",
                landing_how_step1_title: "Находите проекты",
                landing_how_step1_desc: "Используйте интерактивную карту или список для поиска строящихся или завершенных объектов рядом с вами.",
                landing_how_step2_title: "Изучайте детали",
                landing_how_step2_desc: "Получите доступ к информации о бюджете, сроках, подрядчике и официальной документации по каждому проекту.",
                landing_how_step3_title: "Делитесь наблюдениями",
                landing_how_step3_desc: "Заметили проблему? Отправьте фото или комментарий с геолокацией прямо через платформу.",
                landing_features_title: "Ключевые возможности",
                landing_feature1_title: "Полная прозрачность",
                landing_feature1_desc: "Вся информация о бюджетах, сроках, подрядчиках и документации в одном месте.",
                landing_feature2_title: "Гражданский мониторинг",
                landing_feature2_desc: "Возможность для каждого гражданина сообщать о реальном состоянии объектов.",
                landing_feature3_title: "AI-анализ отчетов",
                landing_feature3_desc: "Система анализирует данные от граждан и сравнивает их с официальными отчетами для выявления расхождений.",
                landing_feature4_title: "Рейтинг подрядчиков",
                landing_feature4_desc: "Публичный рейтинг компаний, основанный на качестве работ и отзывах граждан.",
                landing_benefits_title: "Польза для всех",
                landing_benefits_citizens_title: "Для Граждан",
                landing_benefits_citizens1: "Реальный контроль за расходованием бюджетных средств.",
                landing_benefits_citizens2: "Возможность влиять на качество инфраструктуры в своем городе.",
                landing_benefits_citizens3: "Удобный инструмент для обратной связи и сообщений о проблемах.",
                landing_benefits_gov_title: "Для Государства",
                landing_benefits_gov1: "Повышение эффективности расходования бюджетных средств.",
                landing_benefits_gov2: "Своевременное выявление проблемных объектов и недобросовестных подрядчиков.",
                landing_benefits_gov3: "Улучшение качества инфраструктуры и повышение доверия граждан.",
                landing_final_cta_title: "Присоединяйтесь к контролю!",
                landing_final_cta_desc: "Начните использовать платформу уже сегодня. Изучайте проекты в вашем районе или сообщите о проблеме, которую вы заметили.",
                landing_final_cta_map: "Посмотреть карту",
                landing_final_cta_report: "Сообщить о проблеме",
                map_title: "Интерактивная карта проектов",
                map_hint: "Нажмите на маркер для просмотра информации о проекте.",
                map_popup_status: "Статус",
                map_popup_budget: "Бюджет",
                map_popup_deadline: "Срок",
                map_popup_contractor: "Подрядчик",
                map_popup_docs: "Документация",
                map_popup_alert: "Внимание: Есть жалобы!",
                projects_title: "Список Инфраструктурных Проектов",
                projects_search_placeholder: "Поиск по названию или подрядчику...",
                projects_not_found: "Проекты не найдены.",
                project_status: "Статус",
                project_budget: "Бюджет",
                project_deadline: "Срок сдачи",
                project_contractor: "Подрядчик",
                project_rating: "Рейтинг",
                project_official_report: "Официальный отчет",
                project_docs_link: "Смотреть документацию",
                project_alert_serious: "Обнаружены серьезные расхождения с отчетами граждан!",
                project_alert_minor: "Поступили жалобы от граждан.",
                project_show_on_map: "Показать на карте",
                project_view_reports_link: "Посмотреть отчеты",
                contractors_title: "Рейтинг Подрядчиков",
                contractor_rating: "Рейтинг",
                contractor_projects_completed: "Завершено проектов",
                contractor_current_projects: "Текущие/завершенные проекты:",
                contractor_no_projects: "Нет информации о проектах",
                report_title: "Сообщить о состоянии объекта",
                report_subtitle: "Заметили проблему со строительством или состоянием объекта? Расскажите нам!",
                report_select_project: "Выберите проект:",
                report_select_placeholder: "-- Выберите проект --",
                report_comment_label: "Ваш комментарий:",
                report_comment_placeholder: "Опишите проблему (например, 'дорогу отремонтировали месяц назад, а уже ямы')",
                report_attach_photo: "Прикрепить фото:", // Изменено
                report_attach_hint: "Допустимые форматы: JPG, PNG, GIF, WEBP (макс. 10MB)", // Изменено
                report_geolocation_label: "Геолокация:", // Изменено
                report_geolocation_fetching: "Получение координат...",
                report_geolocation_success: "Координаты получены",
                report_geolocation_error: "Не удалось получить координаты. Отчет будет отправлен без них.",
                report_geolocation_permission_denied: "Доступ к геолокации запрещен.", // Добавлено
                report_geolocation_unavailable: "Информация о местоположении недоступна.", // Добавлено
                report_geolocation_timeout: "Время ожидания запроса геолокации истекло.", // Добавлено
                report_geolocation_unsupported: "Геолокация не поддерживается вашим браузером.",
                report_submit_button: "Отправить отчет",
                report_latest_reports: "Последние отчеты граждан:",
                report_no_reports: "Пока нет отчетов.",
                report_no_reports_for_project: "Нет отчетов для этого проекта.", // Новый ключ
                report_card_project: "Проект",
                report_card_comment: "Комментарий",
                report_card_date: "Дата",
                report_card_photo: "Фото",
                report_card_location: "Локация",
                report_card_unknown_project: "Неизвестный проект",
                public_reports_title: "Публичные отчеты граждан",
                public_reports_title_filtered: "Отчеты по проекту: {projectName}", // Новый ключ
                public_reports_show_all: "Показать все отчеты", // Новый ключ
                message_success: "Ваш отчет успешно отправлен!",
                message_error_form: "Пожалуйста, выберите проект и напишите комментарий.",
                message_docs_simulation: "Симуляция открытия документа:",
                footer_year: new Date().getFullYear(),
                footer_rights: "Все права защищены.",
                'Loading reports...': 'Загрузка отчетов...', // Ключ для индикатора загрузки
                'Submitting...': 'Отправка...', // Ключ для кнопки отправки
                'Error fetching data ({endpoint}): {message}': 'Ошибка загрузки данных ({endpoint}): {message}', // Ключ для ошибки загрузки
                'Error: Invalid coordinates for this project.': 'Ошибка: Неверные координаты для этого проекта.',
                'Error: Project not found.': 'Ошибка: Проект не найден.',
                'Error: Map not loaded yet.': 'Ошибка: Карта еще не загружена.',
                'Error: Project location data is missing or invalid.': 'Ошибка: Данные о местоположении проекта отсутствуют или неверны.',
                'Error submitting report. Please try again.': 'Ошибка отправки отчета. Пожалуйста, попробуйте еще раз.',
                'Failed to Load Application Data': 'Не удалось загрузить данные приложения',
                'Please check your connection and refresh the page.': 'Пожалуйста, проверьте соединение и обновите страницу.'
            },
            en: {
                platform_title: "Jamoatchilik Qurilish - Civic Control",
                platform_name: "Jamoatchilik Qurilish",
                platform_name_footer: "Jamoatchilik Qurilish",
                nav_home: "Home",
                nav_map: "Map",
                nav_projects: "Projects",
                nav_contractors: "Contractors",
                nav_public_reports: "Reports",
                nav_report: "Report Issue",
                landing_title: "Control Construction. Together.",
                landing_subtitle: "The \"Jamoatchilik Qurilish\" platform is your tool for transparent monitoring of state infrastructure projects in Uzbekistan. Find out budgets, track deadlines, and influence quality.",
                landing_cta_projects: "Explore Projects",
                landing_cta_report: "Report an Issue",
                landing_how_it_works_title: "How it works? Simple.",
                landing_how_step1_title: "Find Projects",
                landing_how_step1_desc: "Use the interactive map or list to search for ongoing or completed projects near you.",
                landing_how_step2_title: "Explore Details",
                landing_how_step2_desc: "Access information about the budget, deadlines, contractor, and official documentation for each project.",
                landing_how_step3_title: "Share Observations",
                landing_how_step3_desc: "Noticed a problem? Submit a photo or comment with geolocation directly through the platform.",
                landing_features_title: "Key Features",
                landing_feature1_title: "Full Transparency",
                landing_feature1_desc: "All information on budgets, deadlines, contractors, and documentation in one place.",
                landing_feature2_title: "Civic Monitoring",
                landing_feature2_desc: "Opportunity for every citizen to report on the actual condition of facilities.",
                landing_feature3_title: "AI Report Analysis",
                landing_feature3_desc: "The system analyzes citizen data and compares it with official reports to identify discrepancies.",
                landing_feature4_title: "Contractor Rating",
                landing_feature4_desc: "Public rating of companies based on the quality of work and citizen feedback.",
                landing_benefits_title: "Benefits for Everyone",
                landing_benefits_citizens_title: "For Citizens",
                landing_benefits_citizens1: "Real control over budget spending.",
                landing_benefits_citizens2: "Ability to influence the quality of infrastructure in your city.",
                landing_benefits_citizens3: "Convenient tool for feedback and reporting issues.",
                landing_benefits_gov_title: "For the Government",
                landing_benefits_gov1: "Increased efficiency of budget spending.",
                landing_benefits_gov2: "Timely identification of problematic projects and unreliable contractors.",
                landing_benefits_gov3: "Improved infrastructure quality and increased public trust.",
                landing_final_cta_title: "Join the Control!",
                landing_final_cta_desc: "Start using the platform today. Explore projects in your area or report a problem you've noticed.",
                landing_final_cta_map: "View Map",
                landing_final_cta_report: "Report an Issue",
                map_title: "Interactive Project Map",
                map_hint: "Click on a marker to view project information.",
                map_popup_status: "Status",
                map_popup_budget: "Budget",
                map_popup_deadline: "Deadline",
                map_popup_contractor: "Contractor",
                map_popup_docs: "Documentation",
                map_popup_alert: "Warning: Complaints received!",
                projects_title: "List of Infrastructure Projects",
                projects_search_placeholder: "Search by name or contractor...",
                projects_not_found: "Projects not found.",
                project_status: "Status",
                project_budget: "Budget",
                project_deadline: "Deadline",
                project_contractor: "Contractor",
                project_rating: "Rating",
                project_official_report: "Official Report",
                project_docs_link: "View Documentation",
                project_alert_serious: "Serious discrepancies found with citizen reports!",
                project_alert_minor: "Complaints received from citizens.",
                project_show_on_map: "Show on Map",
                project_view_reports_link: "View Reports",
                contractors_title: "Contractor Rating",
                contractor_rating: "Rating",
                contractor_projects_completed: "Projects Completed",
                contractor_current_projects: "Current/Completed Projects:",
                contractor_no_projects: "No project information available",
                report_title: "Report Object Condition",
                report_subtitle: "Noticed a problem with the construction or condition of an object? Tell us!",
                report_select_project: "Select project:",
                report_select_placeholder: "-- Select project --",
                report_comment_label: "Your comment:",
                report_comment_placeholder: "Describe the problem (e.g., 'the road was repaired a month ago, but there are already potholes')",
                report_attach_photo: "Attach photo:", // Changed
                report_attach_hint: "Allowed formats: JPG, PNG, GIF, WEBP (max 10MB)", // Changed
                report_geolocation_label: "Geolocation:", // Changed
                report_geolocation_fetching: "Getting coordinates...",
                report_geolocation_success: "Coordinates obtained",
                report_geolocation_error: "Failed to get coordinates. The report will be sent without them.",
                report_geolocation_permission_denied: "Geolocation access denied.", // Added
                report_geolocation_unavailable: "Location information is unavailable.", // Added
                report_geolocation_timeout: "Geolocation request timed out.", // Added
                report_geolocation_unsupported: "Geolocation is not supported by your browser.",
                report_submit_button: "Submit Report",
                report_latest_reports: "Latest Citizen Reports:",
                report_no_reports: "No reports yet.",
                 report_no_reports_for_project: "No reports found for this project.", // New key
                report_card_project: "Project",
                report_card_comment: "Comment",
                report_card_date: "Date",
                report_card_photo: "Photo",
                report_card_location: "Location",
                report_card_unknown_project: "Unknown Project",
                public_reports_title: "Public Citizen Reports",
                public_reports_title_filtered: "Reports for project: {projectName}", // New key
                public_reports_show_all: "Show All Reports", // New key
                message_success: "Your report has been submitted successfully!",
                message_error_form: "Please select a project and write a comment.",
                message_docs_simulation: "Simulation of opening document:",
                footer_year: new Date().getFullYear(),
                footer_rights: "All rights reserved.",
                'Loading reports...': 'Loading reports...',
                'Submitting...': 'Submitting...',
                'Error fetching data ({endpoint}): {message}': 'Error fetching data ({endpoint}): {message}',
                'Error: Invalid coordinates for this project.': 'Error: Invalid coordinates for this project.',
                'Error: Project not found.': 'Error: Project not found.',
                'Error: Map not loaded yet.': 'Error: Map not loaded yet.',
                'Error: Project location data is missing or invalid.': 'Error: Project location data is missing or invalid.',
                'Error submitting report. Please try again.': 'Error submitting report. Please try again.',
                'Failed to Load Application Data': 'Failed to Load Application Data',
                'Please check your connection and refresh the page.': 'Please check your connection and refresh the page.'
            },
            uz: {
                platform_title: "Jamoatchilik Qurilish - Fuqarolik Nazorati",
                platform_name: "Jamoatchilik Qurilish",
                platform_name_footer: "Jamoatchilik Qurilish",
                nav_home: "Bosh sahifa",
                nav_map: "Xarita",
                nav_projects: "Loyihalar",
                nav_contractors: "Pudratchilar",
                nav_public_reports: "Hisobotlar",
                nav_report: "Xabar berish",
                landing_title: "Qurilishni nazorat qiling. Birgalikda.",
                landing_subtitle: "\"Jamoatchilik Qurilish\" platformasi — O'zbekistondagi davlat infratuzilma loyihalarining shaffof monitoringi uchun sizning vositangiz. Byudjetlarni bilib oling, muddatlarni kuzatib boring va sifatga ta'sir qiling.",
                landing_cta_projects: "Loyihalarni o'rganish",
                landing_cta_report: "Muammo haqida xabar berish",
                landing_how_it_works_title: "Qanday ishlaydi? Oddiy.",
                landing_how_step1_title: "Loyihalarni toping",
                landing_how_step1_desc: "Yaqiningizdagi qurilayotgan yoki tugallangan obyektlarni qidirish uchun interaktiv xarita yoki roʻyxatdan foydalaning.",
                landing_how_step2_title: "Tafsilotlarni o'rganing",
                landing_how_step2_desc: "Har bir loyiha bo'yicha byudjet, muddatlar, pudratchi va rasmiy hujjatlar haqidagi ma'lumotlarga ega bo'ling.",
                landing_how_step3_title: "Kuzatuvlaringizni baham ko'ring",
                landing_how_step3_desc: "Muammoni payqadingizmi? Geolokatsiya bilan fotosurat yoki izohni to'g'ridan-to'g'ri platforma orqali yuboring.",
                landing_features_title: "Asosiy imkoniyatlar",
                landing_feature1_title: "To'liq shaffoflik",
                landing_feature1_desc: "Byudjetlar, muddatlar, pudratchilar va hujjatlar haqidagi barcha ma'lumotlar bir joyda.",
                landing_feature2_title: "Fuqarolik monitoringi",
                landing_feature2_desc: "Har bir fuqaro uchun obyektlarning haqiqiy holati to'g'risida xabar berish imkoniyati.",
                landing_feature3_title: "AI-hisobot tahlili",
                landing_feature3_desc: "Tizim fuqarolardan olingan ma'lumotlarni tahlil qiladi va nomuvofiqliklarni aniqlash uchun ularni rasmiy hisobotlar bilan taqqoslaydi.",
                landing_feature4_title: "Pudratchilar reytingi",
                landing_feature4_desc: "Ish sifati va fuqarolarning fikr-mulohazalariga asoslangan kompaniyalarning ommaviy reytingi.",
                landing_benefits_title: "Hamma uchun foyda",
                landing_benefits_citizens_title: "Fuqarolar uchun",
                landing_benefits_citizens1: "Byudjet mablag'larining sarflanishi ustidan haqiqiy nazorat.",
                landing_benefits_citizens2: "O'z shahridagi infratuzilma sifatiga ta'sir qilish imkoniyati.",
                landing_benefits_citizens3: "Qayta aloqa va muammolar haqida xabar berish uchun qulay vosita.",
                landing_benefits_gov_title: "Davlat uchun",
                landing_benefits_gov1: "Byudjet mablag'larini sarflash samaradorligini oshirish.",
                landing_benefits_gov2: "Muammoli obyektlar va vijdonsiz pudratchilarni o'z vaqtida aniqlash.",
                landing_benefits_gov3: "Infratuzilma sifatini yaxshilash va fuqarolar ishonchini oshirish.",
                landing_final_cta_title: "Nazoratga qo'shiling!",
                landing_final_cta_desc: "Bugunoq platformadan foydalanishni boshlang. O'z hududingizdagi loyihalarni o'rganing yoki siz payqagan muammo haqida xabar bering.",
                landing_final_cta_map: "Xaritani ko'rish",
                landing_final_cta_report: "Muammo haqida xabar berish",
                map_title: "Loyihalarning interaktiv xaritasi",
                map_hint: "Loyiha ma'lumotlarini ko'rish uchun belgini bosing.",
                map_popup_status: "Holati",
                map_popup_budget: "Byudjet",
                map_popup_deadline: "Muddati",
                map_popup_contractor: "Pudratchi",
                map_popup_docs: "Hujjatlar",
                map_popup_alert: "Diqqat: Shikoyatlar mavjud!",
                projects_title: "Infratuzilma Loyihalari Ro'yxati",
                projects_search_placeholder: "Nomi yoki pudratchi bo'yicha qidirish...",
                projects_not_found: "Loyihalar topilmadi.",
                project_status: "Holati",
                project_budget: "Byudjet",
                project_deadline: "Topshirish muddati",
                project_contractor: "Pudratchi",
                project_rating: "Reyting",
                project_official_report: "Rasmiy hisobot",
                project_docs_link: "Hujjatlarni ko'rish",
                project_alert_serious: "Fuqarolar hisobotlari bilan jiddiy nomuvofiqliklar aniqlandi!",
                project_alert_minor: "Fuqarolardan shikoyatlar kelib tushdi.",
                project_show_on_map: "Xaritada ko'rsatish",
                project_view_reports_link: "Hisobotlarni ko'rish",
                contractors_title: "Pudratchilar Reytingi",
                contractor_rating: "Reyting",
                contractor_projects_completed: "Tugatilgan loyihalar",
                contractor_current_projects: "Joriy/tugallangan loyihalar:",
                contractor_no_projects: "Loyiha haqida ma'lumot yo'q",
                report_title: "Obyekt holati haqida xabar berish",
                report_subtitle: "Qurilish yoki obyekt holati bilan bog'liq muammoni payqadingizmi? Bizga xabar bering!",
                report_select_project: "Loyihani tanlang:",
                report_select_placeholder: "-- Loyihani tanlang --",
                report_comment_label: "Sizning izohingiz:",
                report_comment_placeholder: "Muammoni tavsiflang (masalan, 'yo'l bir oy oldin ta'mirlandi, lekin allaqachon chuqurlar paydo bo'ldi')",
                report_attach_photo: "Foto biriktirish:", // Changed
                report_attach_hint: "Ruxsat etilgan formatlar: JPG, PNG, GIF, WEBP (maks. 10MB)", // Changed
                report_geolocation_label: "Geolokatsiya:", // Changed
                report_geolocation_fetching: "Koordinatalar olinmoqda...",
                report_geolocation_success: "Koordinatalar olindi",
                report_geolocation_error: "Koordinatalarni olish imkoni bo'lmadi. Hisobot ularsiz yuboriladi.",
                report_geolocation_permission_denied: "Geolokatsiyaga ruxsat berilmadi.", // Added
                report_geolocation_unavailable: "Joylashuv ma'lumotlari mavjud emas.", // Added
                report_geolocation_timeout: "Geolokatsiya so'rovi vaqti tugadi.", // Added
                report_geolocation_unsupported: "Geolokatsiya sizning brauzeringiz tomonidan qo'llab-quvvatlanmaydi.",
                report_submit_button: "Hisobotni yuborish",
                report_latest_reports: "So'nggi fuqarolik hisobotlari:",
                report_no_reports: "Hozircha hisobotlar yo'q.",
                report_no_reports_for_project: "Ushbu loyiha uchun hisobotlar topilmadi.", // New key
                report_card_project: "Loyiha",
                report_card_comment: "Izoh",
                report_card_date: "Sana",
                report_card_photo: "Foto",
                report_card_location: "Joylashuv",
                report_card_unknown_project: "Noma'lum loyiha",
                public_reports_title: "Ommaviy fuqarolik hisobotlari",
                public_reports_title_filtered: "{projectName} loyihasi bo'yicha hisobotlar", // Yangi kalit
                public_reports_show_all: "Barcha hisobotlarni ko'rsatish", // Yangi kalit
                message_success: "Sizning hisobotingiz muvaffaqiyatli yuborildi!",
                message_error_form: "Iltimos, loyihani tanlang va izoh yozing.",
                message_docs_simulation: "Hujjat ochish simulyatsiyasi:",
                footer_year: new Date().getFullYear(),
                footer_rights: "Barcha huquqlar himoyalangan.",
                 'Loading reports...': 'Hisobotlar yuklanmoqda...',
                'Submitting...': 'Yuborilmoqda...',
                'Error fetching data ({endpoint}): {message}': 'Maʼlumotlarni yuklashda xatolik ({endpoint}): {message}',
                'Error: Invalid coordinates for this project.': "Xatolik: Ushbu loyiha uchun noto'g'ri koordinatalar.",
                'Error: Project not found.': 'Xatolik: Loyiha topilmadi.',
                'Error: Map not loaded yet.': 'Xatolik: Xarita hali yuklanmagan.',
                'Error: Project location data is missing or invalid.': "Xatolik: Loyihaning joylashuvi ma'lumotlari yo'q yoki noto'g'ri.",
                'Error submitting report. Please try again.': 'Hisobot yuborishda xatolik. Qaytadan urinib ko‘ring.',
                'Failed to Load Application Data': 'Ilova maʼlumotlarini yuklab boʻlmadi',
                'Please check your connection and refresh the page.': 'Iltimos, ulanishni tekshiring va sahifani yangilang.'
            }
        };

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        const API_BASE_URL = ''; // Оставляем пустым, если фронтенд и бэкенд на одном домене/порту
        // const API_BASE_URL = 'http://localhost:3000'; // Используйте, если развернуто на разных
        let currentLanguage = 'ru';
        let map;
        let markers = {};
        let allProjectsData = []; // Кеш данных проектов
        let allContractorsData = []; // Кеш данных подрядчиков
        let allReportsData = []; // Кеш данных отчетов


        // --- ФУНКЦИИ ---

        // Утилита для загрузки данных
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/${endpoint}`);
                if (!response.ok) {
                    // Пытаемся получить сообщение об ошибке от бэкенда
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) { /* Игнорируем ошибку парсинга JSON */ }
                    const errorMessage = errorData?.message || `HTTP error! status: ${response.status}`;
                    throw new Error(errorMessage);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                // Используем _() для перевода, если ключ существует
                 showMessage(_('Error fetching data ({endpoint}): {message}', { endpoint: endpoint, message: error.message }) || `Error fetching data (${endpoint}): ${error.message}`, 'error', 5000);
                return []; // Возвращаем пустой массив при ошибке
            }
        }

        // --- Обновленная функция установки языка ---
        async function setLanguage(lang) {
            if (!languages[lang]) { lang = 'ru'; }
            currentLanguage = lang;
            const langData = languages[lang];

            // Применяем переводы к элементам с data-lang-key
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                const text = langData[key] || key; // Текст или ключ как fallback

                // Особая обработка заголовка отфильтрованных отчетов
                if (el.id === 'public-reports-title' && text.includes('{projectName}')) {
                    const currentText = el.textContent;
                    if (currentText !== _('public_reports_title')) { // Проверяем, отфильтрован ли сейчас
                        const match = currentText.match(/:\s*(.+)/); // Пытаемся извлечь имя проекта
                        if (match && match[1]) {
                            el.textContent = _('public_reports_title_filtered', { projectName: match[1] });
                        } else {
                             el.textContent = _('public_reports_title'); // Общий заголовок, если не удалось
                        }
                    } else {
                         el.textContent = _('public_reports_title'); // Общий заголовок
                    }
                } else if (langData[key] !== undefined) {
                    el.textContent = text;
                } else {
                     console.warn(`Translation key "${key}" not found for lang "${lang}".`);
                }
            });

             // Применяем переводы к плейсхолдерам
             document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => {
                 const key = el.dataset.langPlaceholderKey;
                 if (langData[key] !== undefined) { el.placeholder = langData[key]; }
                 else { console.warn(`Placeholder key "${key}" not found for lang "${lang}".`); }
             });

            // Обновляем язык документа и заголовок
            document.documentElement.lang = lang;
            document.title = _('platform_title') || 'Jamoatchilik Qurilish';
            document.getElementById('current-lang').textContent = lang.toUpperCase();
            localStorage.setItem('preferredLanguage', lang);

            // Перерисовываем компоненты с кешированными данными на новом языке
            displayProjectsInList();
            displayContractors();
            populateProjectSelect();
            displayCitizenReports(); // Обновляем список последних отчетов в секции отправки

            // Перерисовываем публичные отчеты. Проще всего показать все при смене языка.
            await displayPublicReports(null); // Показываем все публичные отчеты

            if (map) displayProjectsOnMap(); // Перерисовываем маркеры/попапы на карте
            updateFooterYear();
        }

        // --- Помощник для перевода ---
        function _(key, args = null) {
            // Сначала проверяем наличие ключа в текущем языке
            let text = languages[currentLanguage]?.[key];

            // Если ключ не найден в текущем языке, пробуем найти его в английском как fallback
            if (text === undefined) {
                text = languages['en']?.[key];
            }

            // Если ключ не найден и в английском, используем сам ключ
            if (text === undefined) {
                text = key;
            }

            // Подставляем аргументы, если они есть
             if (args && typeof args === 'object' && typeof text === 'string') {
                 for (const k in args) {
                     // Используем RegExp для глобальной замены плейсхолдера
                     const placeholder = new RegExp(`\\{${k}\\}`, 'g');
                     text = text.replace(placeholder, args[k]);
                 }
             }
            return text;
        }


        // --- Функции загрузки и кеширования данных ---
        async function loadProjects() {
            allProjectsData = await fetchData('projects');
            // Убеждаемся, что подрядчики загружены, если они нужны для отображения проектов
            if (allContractorsData.length === 0) await loadContractors();
        }
        async function loadContractors() {
            allContractorsData = await fetchData('contractors');
        }
        async function loadReports(projectId = null) {
             const endpoint = projectId ? `reports?projectId=${projectId}` : 'reports';
             const fetchedReports = await fetchData(endpoint);
             // Сортируем отчеты по дате (сначала новые) после загрузки
             allReportsData = fetchedReports.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

         async function loadInitialData() {
             // Загружаем параллельно, где возможно
             await Promise.all([
                 loadProjects(), // Загружает и подрядчиков, если нужно
                 loadReports()     // Загружаем все отчеты изначально
             ]);
             // Дополнительная проверка на случай, если loadProjects не вызвал loadContractors
             if(allContractorsData.length === 0) await loadContractors();
         }


        // --- Помощники для получения имени/рейтинга подрядчика и имени проекта ---
        function getContractorName(contractorId) {
            const contractor = allContractorsData.find(c => String(c.id) === String(contractorId));
            return contractor ? contractor.name : _('report_card_unknown_project');
        }
        function getContractorRating(contractorId) {
            const contractor = allContractorsData.find(c => String(c.id) === String(contractorId));
             return contractor && typeof contractor.rating === 'number' ? contractor.rating.toFixed(1) : 'N/A';
        }
        function getProjectName(projectId) {
            const project = allProjectsData.find(p => String(p.id) === String(projectId));
            return project ? project.name : _('report_card_unknown_project');
        }

        // --- Инициализация карты ---
        function initializeMap() {
            if (map) { map.remove(); map = null; } // Удаляем предыдущий экземпляр карты
             map = L.map('map').setView([41.3111, 69.2797], 12); // Центр Ташкента по умолчанию
             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                 maxZoom: 19,
                 attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
             }).addTo(map);
             markers = {}; // Сбрасываем объект маркеров
             displayProjectsOnMap(); // Отображаем проекты (уже загруженные)
        }

        // --- Отображение проектов на карте ---
        function displayProjectsOnMap() {
            if (!map || !Array.isArray(allProjectsData)) return;

            // Очищаем существующие маркеры с карты и из объекта
            Object.values(markers).forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
             });
            markers = {};

            if (allProjectsData.length === 0) {
                 console.warn("Нет данных о проектах для отображения на карте.");
                 return;
            }

            allProjectsData.forEach(project => {
                if (!project.location || !Array.isArray(project.location) || project.location.length !== 2) {
                    console.warn(`Проект ${project.id} (${project.name || 'Без имени'}) имеет неверные данные геолокации.`);
                    return; // Пропускаем проекты с неверной геолокацией
                }

                const lat = parseFloat(project.location[0]);
                const lon = parseFloat(project.location[1]);

                 if (isNaN(lat) || isNaN(lon)) {
                     console.warn(`Проект ${project.id} (${project.name || 'Без имени'}) имеет нечисловые координаты.`);
                     return;
                 }

                const marker = L.marker([lat, lon]);

                // Базовая очистка имени проекта от HTML
                const safeProjectName = project.name ? project.name.replace(/</g, "&lt;").replace(/>/g, "&gt;") : _('Unnamed Project'); // Добавлен перевод

                const popupContent = `
                    <div class="text-xs p-1">
                        <b class="text-sm block mb-1">${safeProjectName}</b>
                        <b>${_('map_popup_status')}:</b> ${project.status || 'N/A'}<br>
                        <b>${_('map_popup_budget')}:</b> ${project.budget || 'N/A'}<br>
                        <b>${_('map_popup_deadline')}:</b> ${project.deadline || 'N/A'}<br>
                        <b>${_('map_popup_contractor')}:</b> ${getContractorName(project.contractorId)}<br>
                        <a href="#" onclick="alert('${_('message_docs_simulation')} ${project.docs || _('No document specified')}')" class="text-blue-600 hover:underline">${_('map_popup_docs')}</a>
                        ${project.citizenAlertLevel > 0 ? `<br><b class="text-red-600 mt-1 block">${_('map_popup_alert')}</b>` : ''}
                    </div>`;
                marker.bindPopup(popupContent, {minWidth: 200});
                marker.addTo(map);
                 markers[String(project.id)] = marker; // Используем строковый ID для согласованности
            });
        }


        // --- Отображение списка проектов ---
        function displayProjectsInList(filteredProjects = null) {
            const projectList = document.getElementById('project-list');
            const projectsToDisplay = filteredProjects !== null ? filteredProjects : allProjectsData;
            projectList.innerHTML = '';

            if (!Array.isArray(projectsToDisplay) || projectsToDisplay.length === 0) {
                projectList.innerHTML = `<p class="text-gray-500 italic p-4">${_('projects_not_found')}</p>`;
                return;
            }

            projectsToDisplay.forEach(project => {
                 const alertClass = project.citizenAlertLevel === 2 ? 'border-red-400 bg-red-50/50' : (project.citizenAlertLevel === 1 ? 'border-yellow-400 bg-yellow-50/50' : 'border-gray-200');
                 const alertTextKey = project.citizenAlertLevel === 2 ? 'project_alert_serious' : (project.citizenAlertLevel === 1 ? 'project_alert_minor' : null);
                let alertHtml = '';

                 if (alertTextKey) {
                     const alertTextColor = project.citizenAlertLevel === 2 ? 'text-red-700' : 'text-yellow-700';
                     const alertBgColor = project.citizenAlertLevel === 2 ? 'bg-red-100' : 'bg-yellow-100';
                     const viewReportsLink = `<a href="#" onclick="showProjectReports('${String(project.id)}'); return false;" class="ml-2 text-blue-600 hover:underline font-medium">${_('project_view_reports_link')}</a>`;
                     alertHtml = `<div class="text-xs font-semibold ${alertTextColor} mt-2 p-2 rounded-md ${alertBgColor}">${_(alertTextKey)} ${viewReportsLink}</div>`;
                 }

                 const formattedDeadline = project.deadline || 'N/A';

                const projectCard = `
                    <div class="list-card ${alertClass}">
                        <h3>${project.name || _('Unnamed Project')}</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-600 mb-2">
                             <p><span class="font-medium">${_('project_status')}:</span> ${project.status || 'N/A'}</p>
                             <p><span class="font-medium">${_('project_budget')}:</span> ${project.budget || 'N/A'}</p>
                             <p><span class="font-medium">${_('project_deadline')}:</span> ${formattedDeadline}</p>
                             <p><span class="font-medium">${_('project_contractor')}:</span> ${getContractorName(project.contractorId)} (${_('project_rating')}: ${getContractorRating(project.contractorId)} ★)</p>
                        </div>
                         <p class="text-xs text-gray-600 mt-1 mb-2"><span class="font-medium">${_('project_official_report')}:</span> <span class="italic">${project.officialReport || 'N/A'}</span></p>
                        <div class="flex items-center space-x-4 mt-3">
                            <a href="#" onclick="alert('${_('message_docs_simulation')} ${project.docs || _('No docs')}')" class="text-xs text-blue-600 hover:underline font-medium">${_('project_docs_link')}</a>
                             <button onclick="focusProjectOnMap('${String(project.id)}')" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-200 transition duration-150 ease-in-out flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3 h-3 mr-1"><path fill-rule="evenodd" d="M8.5 4.25a.75.75 0 00-1.5 0v5.5a.75.75 0 001.5 0v-5.5zM5.75 6.5a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5zM4 10a.75.75 0 01.75-.75h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 014 10z" clip-rule="evenodd"></path></svg> ${_('project_show_on_map')}
                            </button>
                         </div>
                         ${alertHtml}
                    </div>`;
                projectList.innerHTML += projectCard;
            });
        }

        // --- Фокусировка на проекте на карте ---
        function focusProjectOnMap(projectId) {
             const projectIdStr = String(projectId);
             const project = allProjectsData.find(p => String(p.id) === projectIdStr);

             if (project && map && project.location && Array.isArray(project.location) && project.location.length === 2) {
                 const lat = parseFloat(project.location[0]);
                 const lon = parseFloat(project.location[1]);

                 if (!isNaN(lat) && !isNaN(lon)) {
                    showSection('map-section', false);
                    map.flyTo([lat, lon], 16);

                    // Убеждаемся, что маркер существует
                     if (markers[projectIdStr]) {
                        setTimeout(() => {
                            if (markers[projectIdStr] && map.hasLayer(markers[projectIdStr])) {
                                markers[projectIdStr].openPopup();
                            }
                         }, 500);
                     } else {
                          console.warn(`Маркер для проекта ${projectIdStr} не найден.`);
                     }
                 } else {
                     console.warn(`Невозможно сфокусироваться на проекте ${projectIdStr}: Неверные координаты.`);
                      showMessage(_('Error: Invalid coordinates for this project.'), 'error');
                 }
             } else if (!project) {
                  console.warn(`Невозможно сфокусироваться: Проект с ID ${projectIdStr} не найден.`);
                  showMessage(_('Error: Project not found.'), 'error');
             } else if (!map) {
                 console.warn(`Невозможно сфокусироваться: Карта не инициализирована.`);
                 showMessage(_('Error: Map not loaded yet.'), 'error');
             } else {
                  console.warn(`Невозможно сфокусироваться на проекте ${projectIdStr}: Отсутствуют или неверные данные геолокации.`);
                  showMessage(_('Error: Project location data is missing or invalid.'), 'error');
             }
        }


        // --- Отображение подрядчиков ---
        function displayContractors() {
            const contractorList = document.getElementById('contractor-list');
            contractorList.innerHTML = '';

            if (!Array.isArray(allContractorsData) || allContractorsData.length === 0) {
                contractorList.innerHTML = `<p class="text-gray-500 italic p-4">${_('contractor_no_projects')}</p>`;
                return;
            }

            // Сортируем по рейтингу (сначала высокий)
            const sortedContractors = [...allContractorsData].sort((a, b) => (b.rating || 0) - (a.rating || 0));

            sortedContractors.forEach(contractor => {
                 const contractorProjects = allProjectsData.filter(p => String(p.contractorId) === String(contractor.id));
                const projectListItems = contractorProjects.length > 0
                    ? contractorProjects.map(p => `<li class="text-xs">${p.name || _('Unnamed Project')} (${p.status || 'N/A'})</li>`).join('')
                    : `<li class="text-xs italic">${_('contractor_no_projects')}</li>`;

                 const contractorRatingDisplay = getContractorRating(contractor.id); // Используем помощника

                const contractorCard = `
                    <div class="list-card">
                        <h3>${contractor.name || _('Unnamed Contractor')}</h3>
                         <p class="text-xs text-gray-600 mt-1 mb-1"><span class="font-medium">${_('contractor_rating')}:</span> <span class="font-bold text-yellow-500">${contractorRatingDisplay} ★</span></p>
                        <p class="text-xs text-gray-600 mb-2"><span class="font-medium">${_('contractor_projects_completed')}:</span> ${contractor.projectsCompleted || 0}</p>
                        <div class="mt-2 border-t border-gray-100 pt-2">
                            <h4 class="text-xs font-semibold text-gray-700 mb-1">${_('contractor_current_projects')}</h4>
                            <ul class="list-disc list-inside text-xs space-y-0.5 pl-2">
                                ${projectListItems}
                            </ul>
                        </div>
                    </div>`;
                contractorList.innerHTML += contractorCard;
            });
        }


        // --- Заполнение выпадающего списка проектов ---
        function populateProjectSelect() {
            const selectElement = document.getElementById('report-project');
            const currentValue = selectElement.value;
            selectElement.innerHTML = '';

            // Добавляем опцию-плейсхолдер
            const placeholderOption = document.createElement('option');
            placeholderOption.value = "";
            placeholderOption.textContent = _('report_select_placeholder');
            placeholderOption.selected = !currentValue; // Выбрана, если ничего не было выбрано ранее
            placeholderOption.disabled = false; // Разрешаем выбрать сначала
            selectElement.appendChild(placeholderOption);

            if (!Array.isArray(allProjectsData) || allProjectsData.length === 0) {
                console.warn("Нет проектов для заполнения выпадающего списка.");
                return;
            }

            // Сортируем проекты по имени
            const sortedProjects = [...allProjectsData].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            sortedProjects.forEach(project => {
                const option = document.createElement('option');
                 option.value = project.id;
                option.textContent = project.name || _('Unnamed Project');
                 option.selected = String(project.id) === currentValue; // Восстанавливаем выбор
                selectElement.appendChild(option);
            });

            // Отключаем плейсхолдер, если выбран валидный проект
            if (selectElement.value !== "") {
                 placeholderOption.disabled = true;
             }
            // Добавляем слушатель, чтобы отключить плейсхолдер после первого выбора
             selectElement.addEventListener('change', function() {
                 const placeholder = this.querySelector('option[value=""]');
                 if(this.value !== "" && placeholder) {
                     placeholder.disabled = true;
                 }
             }, { once: true }); // Сработает только один раз
        }


        // --- Отображение ПОСЛЕДНИХ отчетов граждан (в секции отправки отчета) ---
        function displayCitizenReports() {
            const reportsList = document.getElementById('reports-list');
            reportsList.innerHTML = '';

            if (!Array.isArray(allReportsData) || allReportsData.length === 0) {
                reportsList.innerHTML = `<p class="text-gray-500 italic text-sm">${_('report_no_reports')}</p>`;
                return;
            }

            // Берем 5 самых свежих отчетов (данные уже отсортированы на бэке или в loadReports)
            const recentReports = allReportsData.slice(0, 5);

            recentReports.forEach(report => {
                const projectName = getProjectName(report.projectId);
                 // Форматируем дату/время согласно локали пользователя
                 const formattedDate = report.date ? new Date(report.date).toLocaleString(_('locale_code', 'ru-RU'), { dateStyle: 'medium', timeStyle: 'short' }) : 'N/A';
                 const locationText = report.location ? ` | <span class="whitespace-nowrap">${_('report_card_location')}: ${report.location.lat.toFixed(4)}, ${report.location.lon.toFixed(4)}</span>` : '';
                // Отображаем реальное фото, если оно есть
                const photoHtml = report.photoPath
                     ? `<div class="mt-2"><a href="${report.photoPath}" target="_blank" title="${_('report_card_photo')}"><img src="${report.photoPath}" alt="${_('report_card_photo')} for ${projectName}" class="max-h-32 max-w-full rounded border border-gray-200 shadow-sm" loading="lazy"></a></div>`
                     : '';

                const reportElement = `
                    <div class="border-b border-gray-100 pb-3 mb-3 last:border-b-0 last:pb-0 last:mb-0">
                        <p class="text-sm font-medium text-gray-800 mb-0.5">${projectName}</p>
                        <p class="text-sm text-gray-700 mb-1 break-words">${report.comment || ''}</p>
                         ${photoHtml}
                         <p class="text-xs text-gray-500 mt-1"><span class="whitespace-nowrap">${_('report_card_date')}: ${formattedDate}</span>${locationText}</p>
                    </div>`;
                reportsList.innerHTML += reportElement;
            });
        }

        // --- Отображение ВСЕХ/ОТФИЛЬТРОВАННЫХ публичных отчетов (отдельная секция) ---
        async function displayPublicReports(filterProjectId = null) {
            const publicReportsList = document.getElementById('public-reports-list');
            const reportsTitleElement = document.getElementById('public-reports-title');
            const showAllButton = document.getElementById('show-all-reports-button');
            publicReportsList.innerHTML = `<p class="text-gray-500 italic p-4">${_('Loading reports...')}</p>`; // Индикатор загрузки

            let isFiltered = false;
            let reportsToDisplay = [];

            // Загружаем отчеты (все или отфильтрованные)
             await loadReports(filterProjectId);
             reportsToDisplay = allReportsData; // Используем свежие, отсортированные данные

            // Обновляем заголовок и видимость кнопки
            if (filterProjectId !== null) {
                 isFiltered = true;
                 const project = allProjectsData.find(p => String(p.id) === String(filterProjectId));
                 const projectName = project ? project.name : `ID ${filterProjectId}`;
                 reportsTitleElement.textContent = _('public_reports_title_filtered', { projectName: projectName });
                 showAllButton.classList.remove('hidden');
             } else {
                 reportsTitleElement.textContent = _('public_reports_title');
                 showAllButton.classList.add('hidden');
             }

            // Отображаем отчеты
            publicReportsList.innerHTML = ''; // Очищаем индикатор
            if (!Array.isArray(reportsToDisplay) || reportsToDisplay.length === 0) {
                 const messageKey = isFiltered ? 'report_no_reports_for_project' : 'report_no_reports';
                 publicReportsList.innerHTML = `<p class="text-gray-500 italic p-4">${_(messageKey)}</p>`;
                 return;
            }

            reportsToDisplay.forEach(report => { // Данные уже отсортированы
                 const projectName = getProjectName(report.projectId);
                 const formattedDate = report.date ? new Date(report.date).toLocaleString(_('locale_code', 'ru-RU'), { dateStyle: 'medium', timeStyle: 'short' }) : 'N/A';

                 // Иконки (убедитесь, что SVG или классы иконок соответствуют вашей верстке)
                 const dateIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="icon"><path fill-rule="evenodd" d="M4 1.75a.75.75 0 01.75-.75h6.5a.75.75 0 01.75.75V3h1.75A1.75 1.75 0 0115.5 4.75v8.5A1.75 1.75 0 0113.75 15H2.25A1.75 1.75 0 01.5 13.25v-8.5A1.75 1.75 0 012.25 3H4V1.75zM2 6.25v7A.25.25 0 002.25 13.5h11.5a.25.25 0 00.25-.25v-7H2zM14 4.75a.25.25 0 00-.25-.25H2.25a.25.25 0 00-.25.25V5h12V4.75z" clip-rule="evenodd"></path></svg>`;
                 const projectIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="icon"><path d="M3.75 2a.75.75 0 00-1.5 0v12c0 .414.336.75.75.75h10.5a.75.75 0 00.75-.75V8.75a.75.75 0 00-1.5 0v4.5h-9v-11h3V2H3.75z"></path><path d="M8.75 2a.75.75 0 000 1.5h3.56l-7.22 7.22a.75.75 0 101.06 1.06L13.5 4.31V7.75a.75.75 0 001.5 0V2.75a.75.75 0 00-.75-.75H8.75z"></path></svg>`;
                 // const photoIcon = `...`; // Иконка фото не нужна, если показываем само фото
                 const locationIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="icon"><path fill-rule="evenodd" d="M8 1.75a.75.75 0 01.75.75V3a.75.75 0 01-1.5 0V2.5A.75.75 0 018 1.75zM4.75 4.5a.75.75 0 01.75-.75h5.5a.75.75 0 010 1.5h-5.5a.75.75 0 01-.75-.75zM10.75 8a.75.75 0 01-.75.75H6a.75.75 0 010-1.5h4a.75.75 0 01.75.75zM8 11.75a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5a.75.75 0 01.75-.75z" clip-rule="evenodd"></path><path d="M3.75 0A1.75 1.75 0 002 1.75v12.5c0 .966.784 1.75 1.75 1.75h8.5A1.75 1.75 0 0014 14.25V1.75A1.75 1.75 0 0012.25 0h-8.5zM3.5 1.75c0-.138.112-.25.25-.25h8.5a.25.25 0 01.25.25v12.5a.25.25 0 01-.25.25h-8.5a.25.25 0 01-.25-.25V1.75z"></path></svg>`;

                 const locationHtml = report.location ? `<span class="whitespace-nowrap flex items-center">${locationIcon}${_('report_card_location')}: ${report.location.lat.toFixed(4)}, ${report.location.lon.toFixed(4)}</span>` : '';
                const photoHtml = report.photoPath
                     ? `<div class="mt-2"><a href="${report.photoPath}" target="_blank" title="${_('report_card_photo')}"><img src="${report.photoPath}" alt="${_('report_card_photo')} for ${projectName}" class="max-h-48 max-w-full rounded border border-gray-300 shadow-sm hover:shadow-md transition-shadow" loading="lazy"></a></div>`
                     : '';

                 const reportCard = `
                    <div class="list-card">
                        <h4>${_('report_card_comment')}:</h4>
                        <p class="text-gray-800 mb-2 break-words">${report.comment || ''}</p>
                        ${photoHtml}
                        <div class="report-card-meta flex flex-wrap items-center gap-x-4 gap-y-1 mt-3">
                             <span class="whitespace-nowrap flex items-center">${dateIcon}${_('report_card_date')}: ${formattedDate}</span>
                             <span class="whitespace-nowrap flex items-center">${projectIcon}${_('report_card_project')}: ${projectName}</span>
                             ${locationHtml || ''} {/* Отображаем только если есть */}
                         </div>
                    </div>`;
                publicReportsList.innerHTML += reportCard;
            });
        }


        // --- Логика переключения секций ---
        async function showSection(sectionId, forceRefreshReports = false) { // forceRefreshReports используется для вкладки "Отчеты"
            document.querySelectorAll('.content-section').forEach(section => {
                 if (!section.classList.contains('hidden')) {
                     section.classList.add('hidden');
                     section.style.opacity = 0;
                     section.style.transform = 'translateY(10px)';
                 }
            });

            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                 sectionToShow.classList.remove('hidden');
                 requestAnimationFrame(() => {
                      requestAnimationFrame(() => {
                         sectionToShow.style.opacity = 1;
                         sectionToShow.style.transform = 'translateY(0)';
                      });
                 });
            }

            // Обновляем активную вкладку
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('tab-active');
                if (tab.dataset.section === sectionId) {
                    tab.classList.add('tab-active');
                }
            });

             // Действия при открытии конкретной секции
            switch (sectionId) {
                case 'map-section':
                    if (!map) {
                        initializeMap();
                    } else {
                         setTimeout(() => { if(map) map.invalidateSize() }, 10); // Обновляем размер карты
                    }
                    break;
                 case 'projects-section':
                     displayProjectsInList(); // Перерисовываем список проектов
                     break;
                 case 'contractors-section':
                     displayContractors(); // Перерисовываем список подрядчиков
                     break;
                 case 'citizen-reports-public-section':
                     // Если перешли через главную вкладку (forceRefreshReports=true), показываем все.
                     // Если перешли по ссылке из проекта, displayPublicReports вызовется позже из showProjectReports.
                     // Если просто обновили страницу на этой вкладке, тоже покажем все.
                      await displayPublicReports(forceRefreshReports ? null : undefined);
                     break;
                 case 'report-section':
                     populateProjectSelect(); // Обновляем список проектов в форме
                     displayCitizenReports(); // Показываем последние отчеты под формой
                     getGeolocation();      // Запрашиваем геолокацию при открытии формы
                     break;
            }

            // Скролл вверх, кроме карты
            if (sectionId !== 'map-section') {
                 window.scrollTo({ top: 0, behavior: 'smooth' });
            }
             closeMobileMenu(); // Закрываем мобильное меню при смене секции
        }

        // --- Показ отчетов по конкретному проекту ---
        function showProjectReports(projectId) {
            const projectIdStr = String(projectId);
            // Сначала переключаем на секцию публичных отчетов
            showSection('citizen-reports-public-section', false); // false = не форсировать показ всех
            // Затем вызываем отображение отчетов с фильтром по ID проекта
            displayPublicReports(projectIdStr);
        }

        // --- Получение геолокации ---
        function getGeolocation() {
            const statusElement = document.getElementById('geolocation-status');
            const latInput = document.getElementById('report-latitude');
            const lonInput = document.getElementById('report-longitude');

            statusElement.textContent = _('report_geolocation_fetching');
            statusElement.className = 'text-sm text-gray-500';
            latInput.value = '';
            lonInput.value = '';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        latInput.value = lat.toFixed(6);
                        lonInput.value = lon.toFixed(6);
                        statusElement.textContent = `${_('report_geolocation_success')}: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        statusElement.className = 'text-sm text-green-600';
                    },
                    (error) => {
                        console.error("Geolocation error:", error.code, error.message);
                        let errorKey;
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errorKey = 'report_geolocation_permission_denied'; break;
                            case error.POSITION_UNAVAILABLE: errorKey = 'report_geolocation_unavailable'; break;
                            case error.TIMEOUT: errorKey = 'report_geolocation_timeout'; break;
                            default: errorKey = 'report_geolocation_error';
                        }
                        statusElement.textContent = _(errorKey);
                        statusElement.className = 'text-sm text-red-600';
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                statusElement.textContent = _('report_geolocation_unsupported');
                statusElement.className = 'text-sm text-red-600';
            }
        }

        // --- Обновление года в подвале ---
        function updateFooterYear() {
             const yearElement = document.getElementById('footer-year');
             if (yearElement) yearElement.textContent = new Date().getFullYear();
        }

        // --- Закрытие мобильного меню ---
        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }
        }

        // --- Отображение уведомлений ---
        function showMessage(messageOrKey, type = 'info', duration = 3500) {
            const messageBox = document.getElementById('message-box');
            if (!messageBox) return;

             // Пытаемся перевести, если это ключ, иначе используем как есть
            let messageText = _(messageOrKey); // _() вернет ключ, если перевода нет

            messageBox.textContent = messageText;
            messageBox.className = `message-box ${type}`; // Базовые классы + тип

            // Перезапуск анимации через reflow
            messageBox.style.display = 'none';
            void messageBox.offsetWidth;
            messageBox.style.display = '';
            messageBox.classList.add('show');

            // Очистка предыдущего таймера
             if (messageBox.timerId) {
                 clearTimeout(messageBox.timerId);
             }

            // Установка нового таймера
            messageBox.timerId = setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

        // Отправка формы отчета
        document.getElementById('report-form').addEventListener('submit', async function(event) {
             event.preventDefault();
             const form = this;
             const submitButton = form.querySelector('button[type="submit"]');
             const submitButtonSpan = submitButton.querySelector('span');
             const originalButtonText = submitButtonSpan.textContent;

             submitButton.disabled = true;
             submitButtonSpan.textContent = _('Submitting...');

             const projectId = document.getElementById('report-project').value;
             const comment = document.getElementById('report-comment').value;
             const photoInput = document.getElementById('report-photo');
             const latitude = document.getElementById('report-latitude').value;
             const longitude = document.getElementById('report-longitude').value;

             if (!projectId || !comment.trim()) {
                 showMessage('message_error_form', 'error');
                 submitButton.disabled = false;
                 submitButtonSpan.textContent = originalButtonText;
                 return;
             }

             const formData = new FormData();
             formData.append('projectId', projectId);
             formData.append('comment', comment.trim());
             if (latitude && longitude) {
                 formData.append('latitude', latitude);
                 formData.append('longitude', longitude);
             }
             if (photoInput.files.length > 0) {
                 formData.append('report-photo', photoInput.files[0]);
             }

             try {
                 const response = await fetch(`${API_BASE_URL}/api/reports`, {
                     method: 'POST',
                     body: formData
                 });

                 const result = await response.json();

                 if (!response.ok) {
                     throw new Error(result.message || `HTTP error! status: ${response.status}`);
                 }

                 // --- Успех ---
                 showMessage('message_success', 'success');
                 form.reset(); // Сбрасываем форму
                  const projectSelect = document.getElementById('report-project');
                 projectSelect.value = "";
                 if (projectSelect.options[0]) {
                     projectSelect.options[0].disabled = false;
                     projectSelect.options[0].selected = true;
                 }
                 document.getElementById('geolocation-status').textContent = _('report_geolocation_fetching');
                 document.getElementById('geolocation-status').className = 'text-sm text-gray-500';

                 // --- Обновление данных после отправки ---
                 await loadReports(); // Перезагружаем отчеты
                 displayCitizenReports(); // Обновляем список последних отчетов

                 // Обновляем данные проекта, если бэкенд вернул обновленный проект
                 if (result.updatedProject) {
                     const projectIndex = allProjectsData.findIndex(p => String(p.id) === String(result.updatedProject.id));
                     if (projectIndex !== -1) {
                         allProjectsData[projectIndex] = result.updatedProject;
                         displayProjectsInList();
                         if(map) displayProjectsOnMap();
                     }
                 }

                 // Обновляем секцию публичных отчетов, если она активна
                 const activeSectionId = document.querySelector('.content-section:not(.hidden)')?.id;
                 if (activeSectionId === 'citizen-reports-public-section') {
                      const publicReportsTitle = document.getElementById('public-reports-title').textContent;
                      const isPublicReportsFiltered = publicReportsTitle !== _('public_reports_title');
                      const currentFilterId = isPublicReportsFiltered ? projectId : null;
                      await displayPublicReports(currentFilterId); // Перерисовываем с текущим фильтром (или без)
                 }

                 getGeolocation(); // Запрашиваем геолокацию для следующего отчета

             } catch (error) {
                 console.error("Ошибка отправки отчета:", error);
                 showMessage(error.message || _('Error submitting report. Please try again.'), 'error', 5000);
             } finally {
                 submitButton.disabled = false; // Всегда включаем кнопку обратно
                 submitButtonSpan.textContent = originalButtonText; // Возвращаем исходный текст
             }
        });


        // Поиск проектов
        document.getElementById('project-search').addEventListener('input', function(event) {
            const searchTerm = event.target.value.toLowerCase().trim();

            if (!Array.isArray(allProjectsData)) return;

            const filtered = allProjectsData.filter(project => {
                 const projectName = project.name || '';
                 const contractorName = getContractorName(project.contractorId) || '';
                 return projectName.toLowerCase().includes(searchTerm) ||
                        contractorName.toLowerCase().includes(searchTerm);
             });
            displayProjectsInList(filtered);
        });

        // Кнопка мобильного меню
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // --- Инициализация при загрузке страницы ---
        document.addEventListener('DOMContentLoaded', async () => {
             const savedLang = localStorage.getItem('preferredLanguage');
             const browserLang = navigator.language.split('-')[0];
             const initialLang = savedLang || (languages[browserLang] ? browserLang : 'ru');

             await setLanguage(initialLang); // Устанавливаем язык

             try {
                 // document.body.classList.add('loading'); // Показать индикатор загрузки

                 await loadInitialData(); // Загружаем все начальные данные

                 // Отображаем данные после загрузки
                 displayProjectsInList();
                 displayContractors();
                 populateProjectSelect();
                 displayCitizenReports();
                 await displayPublicReports();

                 // Показываем стартовую секцию
                 showSection('landing-section', false);

                 getGeolocation();
                 updateFooterYear();

             } catch (error) {
                 console.error("Ошибка при начальной загрузке:", error);
                 const mainContentArea = document.querySelector('main');
                 if (mainContentArea) {
                     mainContentArea.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100 rounded-lg">
                         <h2 class="text-xl font-semibold mb-2">${_('Failed to Load Application Data')}</h2>
                         <p>${error.message || _('Please check your connection and refresh the page.')}</p>
                     </div>`;
                 }
             } finally {
                 // document.body.classList.remove('loading'); // Скрыть индикатор загрузки
             }
        });

    </script>

</body>
</html>